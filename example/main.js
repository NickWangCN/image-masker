!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?exports.ImageMasker=t():e.ImageMasker=t()}(self,(()=>(()=>{"use strict";var e={156:(e,t,n)=>{n.d(t,{default:()=>o});var a=function(e,t,n,a){return new(n||(n=Promise))((function(o,i){function r(e){try{l(a.next(e))}catch(e){i(e)}}function c(e){try{l(a.throw(e))}catch(e){i(e)}}function l(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(r,c)}l((a=a.apply(e,t||[])).next())}))};const o=function(e){return a(this,void 0,void 0,(function*(){let t=!1;const n="rgba(0,0,0,1)",o={enableDraw:!0,mode:"draw",shape:"free",brushSize:5,color:"rgba(255, 0, 0, 1)",width:0,height:0,undoAble:!1,redoAble:!1,undo:function(){i.length>1&&(r.push(i.pop()),p(i[i.length-1]),o.redoAble=!0,o.undoAble=i.length>1)},redo:function(){if(r.length>0){const e=r.pop();i.push(e),p(e),o.redoAble=r.length>0,o.undoAble=!0}},clear:function(){o.canvas&&o.ctx&&(o.ctx.clearRect(0,0,o.width,o.height),o.imageData=o.ctx.getImageData(0,0,o.width,o.height),r.length=0,i.push(o.imageData),o.redoAble=!1,o.undoAble=!0)},maskLayerToDataURL:function(){return a(this,void 0,void 0,(function*(){return new Promise(((e,t)=>{o.canvas&&o.ctx?e(o.canvas.toDataURL()):t(new Error("Canvas or ctx is not defined"))}))}))},toDataURL:function(){return a(this,void 0,void 0,(function*(){return new Promise(((e,t)=>{if(!o.canvas||!o.ctx||!o.originalImage)return void t(new Error("Canvas or ctx or originalImage is not defined"));const n=o.canvas.toDataURL(),a=new Image;a.onload=()=>{o.ctx.drawImage(o.originalImage,0,0,o.width,o.height),o.ctx.drawImage(a,0,0);const t=o.canvas.toDataURL();o.ctx.clearRect(0,0,o.width,o.height),o.ctx.drawImage(a,0,0),e(t)},a.src=n}))}))}},i=[],r=[];let c,l,d=null,s=null;const u=e=>{if(o.canvas&&o.ctx&&o.enableDraw&&0===e.button)switch(t=!0,c=e.clientX-o.canvas.getBoundingClientRect().left,l=e.clientY-o.canvas.getBoundingClientRect().top,d=c,s=l,o.shape){case"free":o.ctx.beginPath(),o.ctx.moveTo(c,l),g(c,l);break;case"rect":v(e);break;case"oval":f(e)}};function g(e,t){o.ctx&&(o.ctx.beginPath(),o.ctx.arc(e,t,o.brushSize/2,0,2*Math.PI),o.ctx.fillStyle="erase"===o.mode?n:o.color,o.ctx.fill())}const m=e=>{if(t)switch(o.shape){case"free":!function(e){if(!o.canvas||!o.ctx)return;const t=o.ctx.globalCompositeOperation;"erase"===o.mode&&(o.ctx.globalCompositeOperation="destination-out");const n=o.canvas.getBoundingClientRect(),a=e.clientX-n.left,i=e.clientY-n.top;if(null!==d&&null!==s){const e=a-d,t=i-s,n=Math.sqrt(e*e+t*t),r=o.brushSize/2;for(let a=0;a<n;a+=r){const o=a/n;g(d+o*e,s+o*t)}}g(a,i),d=a,s=i,"erase"===o.mode&&(o.ctx.globalCompositeOperation=t)}(e);break;case"rect":v(e);break;case"oval":f(e)}},h=e=>{o.canvas&&o.ctx&&o.enableDraw&&0===e.button&&(t=!1,o.imageData=o.ctx.getImageData(0,0,o.width,o.height),r.length=0,i.push(o.imageData),o.redoAble=!1,o.undoAble=!0,d=null,s=null)};function p(e){e&&(o.imageData=e,o.ctx.putImageData(e,0,0))}function v(e){if(!o.canvas||!o.ctx||!o.imageData)return;const t=o.ctx.globalCompositeOperation;"erase"===o.mode&&(o.ctx.globalCompositeOperation="destination-out"),p(o.imageData);const a=o.canvas.getBoundingClientRect(),i=e.clientX-a.left,r=e.clientY-a.top;o.ctx.fillStyle="erase"===o.mode?n:o.color;const d=i-c,s=r-l;o.ctx.fillRect(c,l,d,s),"erase"===o.mode&&(o.ctx.globalCompositeOperation=t)}function f(e){if(!o.canvas||!o.ctx||!o.imageData)return;p(o.imageData);const t=o.ctx.globalCompositeOperation;"erase"===o.mode&&(o.ctx.globalCompositeOperation="destination-out");const a=o.canvas.getBoundingClientRect(),i=e.clientX-a.left,r=e.clientY-a.top;o.ctx.fillStyle="erase"===o.mode?n:o.color,o.ctx.beginPath(),o.ctx.ellipse((c+i)/2,(l+r)/2,Math.abs(i-c)/2,Math.abs(r-l)/2,0,0,2*Math.PI),o.ctx.fill(),"erase"===o.mode&&(o.ctx.globalCompositeOperation=t)}const x=e.parentElement instanceof HTMLElement?e.parentElement:document.getElementById(e.parentElement);if(!x)throw new Error("Please provide a valid parent element");x.innerHTML="";const w=document.createElement("div");w.style.background=e.background||"#000",w.style.padding=e.padding||"4px",w.style.display="flex",w.style.justifyContent="center",w.style.alignItems="center",w.style.width=x.clientWidth+"px",w.style.height=x.clientHeight+"px",w.style.flex="1",x.appendChild(w);const{width:b,height:y}=function(e){const t=e.getBoundingClientRect(),n=window.getComputedStyle(e),a=parseFloat(n.paddingLeft||"0"),o=parseFloat(n.paddingRight||"0"),i=parseFloat(n.paddingTop||"0"),r=parseFloat(n.paddingBottom||"0");return{width:t.width-(a+o),height:t.height-(i+r)}}(w);return new Promise((t=>{const n=new Image;n.onload=function(){const n=function(e,t,n,a){const o=Math.min(n/t.width,a/t.height),i=t.width*o,r=t.height*o,c=document.createElement("canvas");c.style.backgroundImage=`url(${t.src})`,c.style.backgroundSize="100% 100%",c.width=i,c.height=r,e.appendChild(c);const l=c.getContext("2d",{willReadFrequently:!0});return e.appendChild(c),function(e){e.addEventListener("mousedown",(e=>{e.stopPropagation()})),e.addEventListener("mousemove",(e=>{e.stopPropagation()})),e.addEventListener("mouseup",(e=>{e.stopPropagation()})),e.addEventListener("click",(e=>{e.stopPropagation()})),e.addEventListener("mousedown",u),e.addEventListener("mousemove",m),e.addEventListener("mouseup",h)}(e),{canvas:c,ctx:l,width:i,height:r,originalImage:t}}(w,e.image,b,y);o.canvas=n.canvas,o.ctx=n.ctx,o.width=n.width,o.height=n.height,o.originalImage=n.originalImage,o.imageData=o.ctx.getImageData(0,0,o.width,o.height),i.push(o.imageData),t(o)},n.src=e.image.src}))}))}}},t={};function n(a){var o=t[a];if(void 0!==o)return o.exports;var i=t[a]={exports:{}};return e[a](i,i.exports,n),i.exports}n.d=(e,t)=>{for(var a in t)n.o(t,a)&&!n.o(e,a)&&Object.defineProperty(e,a,{enumerable:!0,get:t[a]})},n.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t);var a={},o=n(156),i=function(e,t,n,a){return new(n||(n=Promise))((function(o,i){function r(e){try{l(a.next(e))}catch(e){i(e)}}function c(e){try{l(a.throw(e))}catch(e){i(e)}}function l(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(r,c)}l((a=a.apply(e,t||[])).next())}))};return document.addEventListener("DOMContentLoaded",(()=>{var e,t,n,a,r,c,l,d,s;let u;const g=document.getElementById("imageInput"),m=document.querySelector(".upload-area"),h=document.getElementById("masker");function p(e){if(!e.type.startsWith("image/"))return void alert("请选择图片文件！");const t=new FileReader;t.onload=e=>i(this,void 0,void 0,(function*(){var t;if(null===(t=e.target)||void 0===t?void 0:t.result){const t=new Image;t.src=e.target.result;const n={parentElement:h,image:t};u=yield(0,o.default)(n)}})),t.readAsDataURL(e)}null===(e=document.getElementById("brushSize"))||void 0===e||e.addEventListener("change",(e=>{u&&(u.brushSize=e.target.value)})),null===(t=document.getElementById("mode"))||void 0===t||t.addEventListener("change",(e=>{u&&(u.mode=e.target.value)})),null===(n=document.getElementById("shape"))||void 0===n||n.addEventListener("change",(e=>{u&&(u.shape=e.target.value)})),null===(a=document.getElementById("undo"))||void 0===a||a.addEventListener("click",(()=>{null==u||u.undo()})),null===(r=document.getElementById("redo"))||void 0===r||r.addEventListener("click",(()=>{null==u||u.redo()})),null===(c=document.getElementById("clear"))||void 0===c||c.addEventListener("click",(()=>{null==u||u.clear()})),null===(l=document.getElementById("enableDraw"))||void 0===l||l.addEventListener("change",(e=>{u&&(e.target.checked?u.enableDraw=!0:u.enableDraw=!1)})),null===(d=document.getElementById("preview"))||void 0===d||d.addEventListener("click",(()=>i(void 0,void 0,void 0,(function*(){if(u){const e=yield u.toDataURL(),t=document.getElementById("masker-preview");if(t){t.innerHTML="";const n=new Image;n.src=e,t.appendChild(n)}}})))),null===(s=document.getElementById("maskOnly"))||void 0===s||s.addEventListener("click",(()=>i(void 0,void 0,void 0,(function*(){if(u){const e=yield u.maskLayerToDataURL(),t=document.getElementById("masker-preview");if(t){t.innerHTML="";const n=new Image;n.src=e,t.appendChild(n)}}})))),g.addEventListener("change",(function(e){const t=e.target.files;t&&t[0]&&p(t[0])})),m.addEventListener("dragover",(e=>{e.preventDefault(),m.style.borderColor="#000"})),m.addEventListener("dragleave",(()=>{m.style.borderColor="#ccc"})),m.addEventListener("drop",(e=>{var t;e.preventDefault(),m.style.borderColor="#ccc";const n=null===(t=e.dataTransfer)||void 0===t?void 0:t.files;n&&n[0]&&p(n[0])}))})),a.default})()));