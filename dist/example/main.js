!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?exports.ImageMasker=t():e.ImageMasker=t()}(self,(()=>(()=>{"use strict";var e={156:(e,t,n)=>{n.d(t,{default:()=>a});var o=function(e,t,n,o){return new(n||(n=Promise))((function(a,i){function r(e){try{d(o.next(e))}catch(e){i(e)}}function c(e){try{d(o.throw(e))}catch(e){i(e)}}function d(e){var t;e.done?a(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(r,c)}d((o=o.apply(e,t||[])).next())}))};const a=function(e){return o(this,void 0,void 0,(function*(){let t=!1;const n="rgba(0,0,0,1)",a={mode:"draw",shape:"free",brushSize:5,color:"rgba(255, 0, 0, 1)",width:0,height:0,undoAble:!1,redoAble:!1,undo:function(){i.length>1&&(r.push(i.pop()),g(i[i.length-1]),a.redoAble=!0,a.undoAble=i.length>1)},redo:function(){if(r.length>0){const e=r.pop();i.push(e),g(e),a.redoAble=r.length>0,a.undoAble=!0}},maskLayerToDataURL:function(){return o(this,void 0,void 0,(function*(){return new Promise(((e,t)=>{a.canvas&&a.ctx?e(a.canvas.toDataURL()):t(new Error("Canvas or ctx is not defined"))}))}))},toDataURL:function(){return o(this,void 0,void 0,(function*(){return new Promise(((e,t)=>{if(!a.canvas||!a.ctx||!a.originalImage)return void t(new Error("Canvas or ctx or originalImage is not defined"));const n=a.canvas.toDataURL(),o=new Image;o.onload=()=>{a.ctx.drawImage(a.originalImage,0,0,a.width,a.height),a.ctx.drawImage(o,0,0);const t=a.canvas.toDataURL();a.ctx.clearRect(0,0,a.width,a.height),a.ctx.drawImage(o,0,0),e(t)},o.src=n}))}))}},i=[],r=[],c=e=>{if(a.canvas&&a.ctx&&0===e.button)switch(t=!0,s=e.clientX-a.canvas.getBoundingClientRect().left,u=e.clientY-a.canvas.getBoundingClientRect().top,a.shape){case"free":a.ctx.beginPath(),a.ctx.moveTo(s,u);break;case"rect":m(e);break;case"oval":p(e)}},d=e=>{if(t)switch(a.shape){case"free":!function(e){if(!a.canvas||!a.ctx)return;const t=a.ctx.globalCompositeOperation;"erase"===a.mode&&(a.ctx.globalCompositeOperation="destination-out");const o=a.canvas.getBoundingClientRect(),i=e.clientX-o.left,r=e.clientY-o.top;a.ctx.lineTo(i,r),a.ctx.strokeStyle="erase"===a.mode?n:a.color,a.ctx.lineWidth=a.brushSize,a.ctx.stroke(),"erase"===a.mode&&(a.ctx.globalCompositeOperation=t)}(e);break;case"rect":m(e);break;case"oval":p(e)}},l=e=>{a.canvas&&a.ctx&&0===e.button&&(t=!1,a.imageData=a.ctx.getImageData(0,0,a.width,a.height),r.length=0,i.push(a.imageData),a.redoAble=!1,a.undoAble=!0)};let s,u;function g(e){e&&(a.imageData=e,a.ctx.putImageData(e,0,0))}function m(e){if(!a.canvas||!a.ctx||!a.imageData)return;const t=a.ctx.globalCompositeOperation;"erase"===a.mode&&(a.ctx.globalCompositeOperation="destination-out"),g(a.imageData);const o=a.canvas.getBoundingClientRect(),i=e.clientX-o.left,r=e.clientY-o.top;a.ctx.fillStyle="erase"===a.mode?n:a.color;const c=i-s,d=r-u;a.ctx.fillRect(s,u,c,d),"erase"===a.mode&&(a.ctx.globalCompositeOperation=t)}function p(e){if(!a.canvas||!a.ctx||!a.imageData)return;g(a.imageData);const t=a.ctx.globalCompositeOperation;"erase"===a.mode&&(a.ctx.globalCompositeOperation="destination-out");const o=a.canvas.getBoundingClientRect(),i=e.clientX-o.left,r=e.clientY-o.top;a.ctx.fillStyle="erase"===a.mode?n:a.color,a.ctx.beginPath(),a.ctx.ellipse((s+i)/2,(u+r)/2,Math.abs(i-s)/2,Math.abs(r-u)/2,0,0,2*Math.PI),a.ctx.fill(),"erase"===a.mode&&(a.ctx.globalCompositeOperation=t)}const v=e.parentElement instanceof HTMLElement?e.parentElement:document.getElementById(e.parentElement);if(!v)throw new Error("Please provide a valid parent element");v.innerHTML="";const h=document.createElement("div");h.style.background=e.background||"#000",h.style.padding=e.padding||"4px",h.style.display="flex",h.style.justifyContent="center",h.style.alignItems="center",h.style.width=v.clientWidth+"px",h.style.height=v.clientHeight+"px",h.style.flex="1",v.appendChild(h);const{width:f,height:x}=function(e){const t=e.getBoundingClientRect(),n=window.getComputedStyle(e),o=parseFloat(n.paddingLeft||"0"),a=parseFloat(n.paddingRight||"0"),i=parseFloat(n.paddingTop||"0"),r=parseFloat(n.paddingBottom||"0");return{width:t.width-(o+a),height:t.height-(i+r)}}(h);return new Promise((t=>{const n=new Image;n.onload=function(){const n=function(e,t,n,o){const a=Math.min(n/t.width,o/t.height),i=t.width*a,r=t.height*a,s=document.createElement("canvas");s.style.backgroundImage=`url(${t.src})`,s.style.backgroundSize="100% 100%",s.width=i,s.height=r,e.appendChild(s);const u=s.getContext("2d",{willReadFrequently:!0});return e.appendChild(s),function(e){e.addEventListener("mousedown",(e=>{e.stopPropagation()})),e.addEventListener("mousemove",(e=>{e.stopPropagation()})),e.addEventListener("mouseup",(e=>{e.stopPropagation()})),e.addEventListener("click",(e=>{e.stopPropagation()})),e.addEventListener("mousedown",c),e.addEventListener("mousemove",d),e.addEventListener("mouseup",l)}(e),{canvas:s,ctx:u,width:i,height:r,originalImage:t}}(h,e.image,f,x);a.canvas=n.canvas,a.ctx=n.ctx,a.width=n.width,a.height=n.height,a.originalImage=n.originalImage,a.imageData=a.ctx.getImageData(0,0,a.width,a.height),i.push(a.imageData),t(a)},n.src=e.image.src}))}))}}},t={};function n(o){var a=t[o];if(void 0!==a)return a.exports;var i=t[o]={exports:{}};return e[o](i,i.exports,n),i.exports}n.d=(e,t)=>{for(var o in t)n.o(t,o)&&!n.o(e,o)&&Object.defineProperty(e,o,{enumerable:!0,get:t[o]})},n.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t);var o={},a=n(156),i=function(e,t,n,o){return new(n||(n=Promise))((function(a,i){function r(e){try{d(o.next(e))}catch(e){i(e)}}function c(e){try{d(o.throw(e))}catch(e){i(e)}}function d(e){var t;e.done?a(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(r,c)}d((o=o.apply(e,t||[])).next())}))};return document.addEventListener("DOMContentLoaded",(()=>{var e,t,n,o,r,c,d;let l;const s=document.getElementById("imageInput"),u=document.querySelector(".upload-area"),g=document.getElementById("masker");function m(e){if(!e.type.startsWith("image/"))return void alert("请选择图片文件！");const t=new FileReader;t.onload=e=>i(this,void 0,void 0,(function*(){var t;if(null===(t=e.target)||void 0===t?void 0:t.result){const t=new Image;t.src=e.target.result;const n={parentElement:g,image:t};l=yield(0,a.default)(n)}})),t.readAsDataURL(e)}null===(e=document.getElementById("brushSize"))||void 0===e||e.addEventListener("change",(e=>{l&&(l.brushSize=e.target.value)})),null===(t=document.getElementById("mode"))||void 0===t||t.addEventListener("change",(e=>{l&&(l.mode=e.target.value)})),null===(n=document.getElementById("shape"))||void 0===n||n.addEventListener("change",(e=>{l&&(l.shape=e.target.value)})),null===(o=document.getElementById("undo"))||void 0===o||o.addEventListener("click",(()=>{null==l||l.undo()})),null===(r=document.getElementById("redo"))||void 0===r||r.addEventListener("click",(()=>{null==l||l.redo()})),null===(c=document.getElementById("preview"))||void 0===c||c.addEventListener("click",(()=>i(void 0,void 0,void 0,(function*(){if(l){const e=yield l.toDataURL(),t=document.getElementById("masker-preview");if(t){t.innerHTML="";const n=new Image;n.src=e,t.appendChild(n)}}})))),null===(d=document.getElementById("maskOnly"))||void 0===d||d.addEventListener("click",(()=>i(void 0,void 0,void 0,(function*(){if(l){const e=yield l.maskLayerToDataURL(),t=document.getElementById("masker-preview");if(t){t.innerHTML="";const n=new Image;n.src=e,t.appendChild(n)}}})))),s.addEventListener("change",(function(e){const t=e.target.files;t&&t[0]&&m(t[0])})),u.addEventListener("dragover",(e=>{e.preventDefault(),u.style.borderColor="#000"})),u.addEventListener("dragleave",(()=>{u.style.borderColor="#ccc"})),u.addEventListener("drop",(e=>{var t;e.preventDefault(),u.style.borderColor="#ccc";const n=null===(t=e.dataTransfer)||void 0===t?void 0:t.files;n&&n[0]&&m(n[0])}))})),o.default})()));